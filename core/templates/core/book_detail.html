{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/book_detail.css' %}">
{% endblock %}

{% block content %}
<div class="book-detail-container">
    <div class="breadcrumbs">
        <a href="{% url 'core:home' %}">–ì–æ–ª–æ–≤–Ω–∞</a> / {{ book.title }}
    </div>

    <div class="book-header">
        <div class="book-cover-large">
            {% with cover=book.get_cover %}
                {% if cover %}
                    <img src="{{ cover }}" alt="{{ book.title }}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'no-cover\'>üìö</div>'">
                {% else %}
                    <div class="no-cover">üìö</div>
                {% endif %}
            {% endwith %}
        </div>

        <div class="book-info">
            <h1>{{ book.title }}</h1>
            <h2 class="author">{{ book.author }}</h2>

            <p class="meta">
                <span>{{ book.year }}</span> ‚Ä¢ {{ book.genre }} ‚Ä¢ üëÅ {{ book.views_count }}
            </p>

            <p class="description">{{ book.description }}</p>

            <div class="actions">
                {% if user.is_authenticated %}
                    <a href="{% url 'core:save_book' book.id %}" class="btn-primary">
                        {% if is_saved %}üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–æ{% else %}üìö –ó–±–µ—Ä–µ–≥—Ç–∏{% endif %}
                    </a>
                    <a href="{% url 'core:create_playlist' book.id %}" class="btn-secondary">
                        üéµ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–ª–µ–π–ª–∏—Å—Ç
                    </a>
                    <a href="{% url 'core:add_chapters' book.id %}" class="btn-secondary">
                        ‚ûï –î–æ–¥–∞—Ç–∏ —Ä–æ–∑–¥—ñ–ª–∏
                    </a>
                {% else %}
                    <a href="{% url 'login' %}" class="btn-primary">–£–≤—ñ–π—Ç–∏</a>
                {% endif %}
            </div>
        </div>
    </div>

    <section class="chapters-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="margin-bottom: 0;">üìñ –†–æ–∑–¥—ñ–ª–∏ –∫–Ω–∏–≥–∏</h2>
        </div>

        {% if chapters %}
        <div class="chapters-list">
            {% for chapter in chapters %}
            <a href="{% url 'core:chapter_detail' book.id chapter.number %}"
               class="chapter-card {% if not chapter.is_approved %}unapproved{% endif %}">

                <div class="chapter-number">
                    {{ chapter.number }}
                    {% if not chapter.is_approved %}
                        <span title="–û—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è">‚ö†Ô∏è</span>
                    {% endif %}
                </div>

                <div class="chapter-info">
                    <h3>{{ chapter.title }}</h3>
                    {% if chapter.description %}
                        <p class="chapter-desc">{{ chapter.description|truncatewords:15 }}</p>
                    {% endif %}

                    {% if not chapter.is_approved %}
                        <small style="color: #ea6666;">(–ù–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó)</small>
                    {% endif %}
                </div>
                <div class="chapter-stats">
                    üéµ {{ chapter.music_recommendations.count }}
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>–†–æ–∑–¥—ñ–ª—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.</p>
            <a href="{% url 'core:add_chapters' book.id %}" class="btn-primary">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—à—ñ —Ä–æ–∑–¥—ñ–ª–∏</a>
        </div>
        {% endif %}
    </section>

    {% if top_music %}
    <section class="top-music-section">
        <h2>üéµ –¢–æ–ø –º—É–∑–∏—á–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π</h2>
        <div class="music-list-compact">
            {% for music in top_music %}
            <div class="music-item-compact">
                <div class="music-info">
                    <h4>{{ music.track_title }}</h4>
                    <p>{{ music.artist }} ‚Ä¢ –†–æ–∑–¥—ñ–ª {{ music.chapter.number }}</p>
                </div>
                <div class="music-stats">
                    <span>‚ù§Ô∏è {{ music.likes_count }}</span>
                    <a href="{{ music.link_url }}" target="_blank" class="btn-link">–°–ª—É—Ö–∞—Ç–∏</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if popular_playlists %}
    <section class="playlists-section">
        <h2>üéº –ü–æ–ø—É–ª—è—Ä–Ω—ñ –ø–ª–µ–π–ª–∏—Å—Ç–∏</h2>
        <div class="playlists-grid">
            {% for playlist in popular_playlists %}
            <a href="{% url 'core:playlist_detail' playlist.pk %}" class="playlist-card">
                <h3>{{ playlist.title }}</h3>
                <p>{{ playlist.description|truncatewords:15 }}</p>
                <div class="playlist-meta">
                    <span>üë§ {{ playlist.creator.username }}</span>
                    <span>‚ù§Ô∏è {{ playlist.likes_count }}</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

<style>
.chapter-card.unapproved {
    opacity: 0.7;
    border: 1px dashed #ea6666;
    background: rgba(234, 102, 102, 0.1);
}
.no-cover {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5rem;
    border-radius: 15px;
}
</style>
{% endblock %}