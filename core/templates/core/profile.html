{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/profile.css' %}">
<link rel="stylesheet" href="{% static 'core/css/forms.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <h1 style="display: flex; align-items: center; gap: 0.5rem;">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        Мій профіль
    </h1>

    <p class="username">{{ user.username }}</p>

    <div class="edit-profile-section" style="margin-bottom: 2rem; background: rgba(45,53,97,0.4); padding: 2rem; border-radius: 20px; border: 1px solid rgba(102, 126, 234, 0.2);">
        <h3 style="color: #e8eaf6; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            Редагувати дані
        </h3>

        <form method="post">
            {% csrf_token %}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem;">
                {% for field in form %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}" style="color: #b8c5d6; margin-bottom: 0.5rem; display: block;">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}
                        <span class="error" style="color: #ff6b6b; font-size: 0.85rem; margin-top: 5px; display: block;">{{ field.errors.0 }}</span>
                    {% endif %}
                    {% if field.help_text and field.name != 'username' %}
                        <small style="color: #7a8aa3; display: block; margin-top: 5px;">{{ field.help_text }}</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="form-actions" style="margin-top: 1.5rem;">
                <button type="submit" class="btn-primary" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Зберегти зміни
                </button>
            </div>
        </form>
    </div>

    <div class="profile-tabs">
        <button class="tab active" onclick="showTab('saved')" style="display: flex; align-items: center; gap: 0.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
            Збережені книги ({{ saved_books.count }})
        </button>
        <button class="tab" onclick="showTab('playlists')" style="display: flex; align-items: center; gap: 0.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
            Мої плейлисти ({{ my_playlists.count }})
        </button>
        <button class="tab" onclick="showTab('music')" style="display: flex; align-items: center; gap: 0.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
            Мої рекомендації ({{ my_recommendations.count }})
        </button>
    </div>

    <div id="saved-tab" class="tab-content active">
        <div class="books-grid">
            {% for saved in saved_books %}
            <a href="{% url 'core:book_detail' saved.book.id %}" class="book-card">
                {% if saved.book.get_cover %}
                    <img src="{{ saved.book.get_cover }}" alt="{{ saved.book.title }}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'no-cover\' style=\'height:250px; display:flex; align-items:center; justify-content:center; background:#2d3561; border-radius:10px;\'><svg xmlns=\'http://www.w3.org/2000/svg\' width=\'50\' height=\'50\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'white\' stroke-width=\'1\' stroke-linecap=\'round\' stroke-linejoin=\'round\'><path d=\'M4 19.5A2.5 2.5 0 0 1 6.5 17H20\'></path><path d=\'M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z\'></path></svg></div>'">
                {% else %}
                    <div class="no-cover" style="height:250px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    </div>
                {% endif %}
                <h3 style="margin-top: 1rem;">{{ saved.book.title }}</h3>
                <p>{{ saved.book.author }}</p>
            </a>
            {% empty %}
            <p class="empty">У вас поки немає збережених книг</p>
            {% endfor %}
        </div>
    </div>

    <div id="playlists-tab" class="tab-content">
        <div class="playlists-list">
            {% for playlist in my_playlists %}
            <a href="{% url 'core:playlist_detail' playlist.id %}" class="playlist-item">
                <div>
                    <h3>{{ playlist.title }}</h3>
                    <p>{{ playlist.book.title }}</p>
                </div>
                <span style="display: flex; align-items: center; gap: 5px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
                    {{ playlist.likes_count }}
                </span>
            </a>
            {% empty %}
            <p class="empty">Ви ще не створили жодного плейлиста</p>
            {% endfor %}
        </div>
    </div>

    <div id="music-tab" class="tab-content">
        <div class="music-list">
            {% for music in my_recommendations %}
            <div class="music-item">
                <div>
                    <h3>{{ music.track_title }}</h3>
                    <p>{{ music.artist }}</p>
                    <p class="book-info">
                        {{ music.chapter.book.title }} - Розділ {{ music.chapter.number }}
                    </p>
                </div>
                <span style="display: flex; align-items: center; gap: 5px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg>
                    {{ music.likes_count }}
                </span>
            </div>
            {% empty %}
            <p class="empty">Ви ще не додали жодної рекомендації</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });
    document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
    });

    const activeTab = document.getElementById(tabName + '-tab');
    if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.display = 'block';
    }
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('active');
    }
}

// Ініціалізація першого табу при завантаженні
document.addEventListener('DOMContentLoaded', function() {
    // Приховуємо всі крім першого
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');

    const firstTab = document.getElementById('saved-tab');
    if(firstTab) firstTab.style.display = 'block';

    // Активуємо кнопку
    const firstBtn = document.querySelector('.profile-tabs .tab');
    if(firstBtn) firstBtn.classList.add('active');
});
</script>
{% endblock %}